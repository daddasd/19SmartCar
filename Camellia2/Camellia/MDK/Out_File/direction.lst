C251 COMPILER V5.60.0,  direction                                                          08/05/24  21:18:53  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE direction
OBJECT MODULE PLACED IN .\Out_File\direction.obj
COMPILER INVOKED BY: E:\Keil5C251\C251\BIN\C251.EXE ..\USER\Hardware\direction.c XSMALL WARNINGLEVEL(3) OPTIMIZE(0,SPEED
                    -) BROWSE INCDIR(..\..\Libraries\libraries;..\..\Libraries\seekfree_libraries;..\..\Libraries\seekfree_peripheral;..\CODE
                    -;..\USER\inc;..\USER\src;..\USER\Hardware;..\USER\Hardware) DEBUG PRINT(.\Out_File\direction.lst) TABS(2) OBJECT(.\Out_F
                    -ile\direction.obj) 

stmt  level    source

    1          /*
    2           * @Description:
    3           * @Author: Yzhi
    4           * @Date: 2023-11-17 21:24:19
    5           * @LastEditTime: 2024-01-19 11:52:20
    6           * @LastEditors: Yzhi
    7           */
    8          #include "myconfig.h"
    9          
   10          #define out_max 20000
   11          #define Angle_MAX 3500
   12          
   13          float Nh_P = 100;  // 0.5
   14          float Nh_D = 1.50; // 4.1
   15          float Wh_P = 90;
   16          float Wh_D = 320;
   17          
   18          //--
   19          //@brief      方向环(外环) 位置式
   20          //@param      c hazhi : 电感差值 KP 比例 KI 积分 KD 微分
   21          //@return     void
   22          //--
   23          
   24          int wh_Turn_Out(int16 chazhi, float dir_p, float dir_d)
   25          {
   26   1        float error;
   27   1        static float last_error = 0;
   28   1        float Output;
   29   1        float error_derivative;
   30   1        // 计算位置误差
   31   1        error = chazhi;
   32   1        // 计算位置误差变化率
   33   1        error_derivative = error - last_error;
   34   1        // 计算PD控制器的输出
   35   1        Output = error * dir_p + error_derivative * dir_d;
   36   1        // 更新上一时刻的位置误差
   37   1        last_error = error;
   38   1        // 对输出进行限幅
   39   1        Output = limit(Output, out_max);
   40   1        return (int)Output;
   41   1      }
   42          
   43          //--
   44          //@brief      方向环(内环) 位置式
   45          //@param      chazhi : 电感差值 KP 比例 KI 积分 KD 微分
   46          //@return     void
   47          //--
   48          
   49          int nh_Turn_Out(int err, float dir_p, float dir_i)
   50          {
   51   1        int error1 = 0;
   52   1        static float last_err = 0, nh_out = 0, P_out = 0, I_out = 0, out = 0;
   53   1        error1 = err - mpu6050_gyro_z / 65.6;
   54   1        P_out = dir_p * (error1 - last_err);
   55   1        I_out = dir_i * error1;
   56   1        if (I_out > 2000)
C251 COMPILER V5.60.0,  direction                                                          08/05/24  21:18:53  PAGE 2   

   57   1          I_out = 2000;
   58   1        if (I_out < -2000)
   59   1          I_out = -2000;
   60   1        out = P_out + I_out;
   61   1        nh_out += out;
   62   1        last_err = error1;
   63   1        return (int)nh_out;
   64   1      }
   65          
   66          //--
   67          //@brief      方向环控制（内环1ms外环3ms）
   68          //@param      void
   69          //@return     方向环输出
   70          //-
   71          int DirControl(void)
   72          {
   73   1        static int count = 0;
   74   1        static int wh_out = 0;
   75   1        if (count == 3)
   76   1        {
   77   2          wh_out = wh_Turn_Out(Inductance_Error, Wh_P, Wh_D);
   78   2          count = 0;
   79   2        }
   80   1        count++;
   81   1        return (int)nh_Turn_Out(wh_out, Nh_P, Nh_D) * count / 3;
   82   1      }
   83          /**
   84           * @brief 角度环
   85           *
   86           * @param target 目标角度
   87           * @param actual 实际角度
   88           */
   89          int Angle_Ring(double target, double actual, float p, float i, float d)
   90          {
   91   1        float error;
   92   1        static float last_error = 0, Ki_val = 0;
   93   1        int Output;
   94   1        float error_derivative;
   95   1        // 计算位置误差
   96   1        error = target - actual;
   97   1        Ki_val += error;
   98   1        if (Ki_val > 1000)
   99   1          Ki_val = 1000;
  100   1        if (Ki_val < -1000)
  101   1          Ki_val = -1000;
  102   1        // 计算位置误差变化率
  103   1        error_derivative = error - last_error;
  104   1        // 计算PD控制器的输出
  105   1        Output = (int)error * p + error_derivative * d + Ki_val * i;
  106   1        // 更新上一时刻的位置误差
  107   1        last_error = error;
  108   1        // 对输出进行限幅
  109   1        Output = limit(Output, Angle_MAX);
  110   1        Motor_PWM(-Output, +Output);
  111   1        if (abs(error) < 5) // 如果误差小于5度代表到达目标角度
  112   1        {
  113   2          return 1;
  114   2        }
  115   1        return 0;
  116   1      }
  117          
  118          /**
  119           * @brief  方向环方案二，陀螺仪作为d项抑制
  120           *
  121           * @param chazhi
  122           * @param dir_p
C251 COMPILER V5.60.0,  direction                                                          08/05/24  21:18:53  PAGE 3   

  123           * @param dir_d
  124           * @param dir_d2
  125           * @return int
  126           */
  127          int DirControl_2(int16 chazhi, float dir_p, float dir_d, float dir_d2)
  128          {
*** WARNING C57 IN LINE 128 OF ..\USER\Hardware\direction.c: parameter 1: different from declaration
  129   1        float error;
  130   1        static float last_error = 0;
  131   1        float Output;
  132   1        float error_derivative;
  133   1        // 计算位置误差
  134   1        error = chazhi;
  135   1        // 计算位置误差变化率
  136   1        error_derivative = error - last_error;
  137   1        // 计算PD控制器的输出
  138   1        Output = error * dir_p + error_derivative * dir_d + mpu6050_gyro_z * dir_d2;
  139   1        // 更新上一时刻的位置误差
  140   1        last_error = error;
  141   1        // 对输出进行限幅
  142   1        Output = limit(Output, out_max);
  143   1        return (int)Output;
  144   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       766     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =       146     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =       116     ------
End of Module Information.


C251 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
