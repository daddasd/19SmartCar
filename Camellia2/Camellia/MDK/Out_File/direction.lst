<<<<<<< HEAD
C251 COMPILER V5.60.0,  direction                                                          06/05/24  21:14:49  PAGE 1   
=======
C251 COMPILER V5.60.0,  direction                                                          06/05/24  21:25:56  PAGE 1   
>>>>>>> 璋


C251 COMPILER V5.60.0, COMPILATION OF MODULE direction
OBJECT MODULE PLACED IN .\Out_File\direction.obj
COMPILER INVOKED BY: E:\Keil5C251\C251\BIN\C251.EXE ..\USER\Hardware\direction.c XSMALL WARNINGLEVEL(3) OPTIMIZE(0,SPEED
                    -) BROWSE INCDIR(..\..\Libraries\libraries;..\..\Libraries\seekfree_libraries;..\..\Libraries\seekfree_peripheral;..\CODE
                    -;..\USER\inc;..\USER\src;..\USER\Hardware;..\USER\Hardware) DEBUG PRINT(.\Out_File\direction.lst) TABS(2) OBJECT(.\Out_F
                    -ile\direction.obj) 

stmt  level    source

    1          /*
    2           * @Description:
    3           * @Author: Yzhi
    4           * @Date: 2023-11-17 21:24:19
    5           * @LastEditTime: 2024-01-19 11:52:20
    6           * @LastEditors: Yzhi
    7           */
    8          #include "myconfig.h"
    9          
   10          #define out_max 20000
   11          #define Angle_MAX 3500
   12          
   13          float Nh_P = 0.1; //0.5
   14          float Nh_D = 0.7; //4.1
   15          float Wh_P = 90;
   16          float Wh_D = 320;
   17          
   18          //--
   19          //@brief      方向环(外环) 位置式
   20          //@param      c hazhi : 电感差值 KP 比例 KI 积分 KD 微分
   21          //@return     void
   22          //--
   23          
   24          int wh_Turn_Out(int16 chazhi, float dir_p, float dir_d)
   25          {
   26   1        float error;
   27   1        static float last_error = 0;
   28   1        float Output;
   29   1        float error_derivative;
   30   1        // 计算位置误差
   31   1        error = chazhi;
   32   1        // 计算位置误差变化率
   33   1        error_derivative = error - last_error;
   34   1        // 计算PD控制器的输出
   35   1        Output = error * dir_p + error_derivative * dir_d;
   36   1        // 更新上一时刻的位置误差
   37   1        last_error = error;
   38   1        // 对输出进行限幅
   39   1        Output = limit(Output, out_max);
   40   1        return (int)Output;
   41   1      }
   42          
   43          //--
   44          //@brief      方向环(内环) 位置式
   45          //@param      chazhi : 电感差值 KP 比例 KI 积分 KD 微分
   46          //@return     void
   47          //--
   48          
   49          int nh_Turn_Out(int err, float dir_p, float dir_i)
   50          {
<<<<<<< HEAD
   51   1        float error;
   52   1        static float last_error = 0;
   53   1        float Output;
   54   1        float error_derivative;
   55   1        // 计算位置误差
   56   1        error = err - mpu6050_gyro_z*0.0075;
C251 COMPILER V5.60.0,  direction                                                          06/05/24  21:14:49  PAGE 2   

   57   1        // 计算位置误差变化率
   58   1        error_derivative = error - last_error;
   59   1        // 计算PD控制器的输出
   60   1        Output = (int)(error * dir_p + error_derivative * dir_d);
   61   1        // 更新上一时刻的位置误差
   62   1        last_error = error;
   63   1        // 对输出进行限幅
   64   1        Output = limit(Output, out_max);
   65   1        return (int)Output;
   66   1      }
   67          
   68          //--
   69          //@brief      方向环控制（内环1ms外环3ms）
   70          //@param      void
   71          //@return     方向环输出
   72          //-
   73          int DirControl(void)
   74          {
   75   1        static int count = 0;
   76   1        static int wh_out = 0;
   77   1        if (count == 3)
   78   1        {
   79   2          wh_out = wh_Turn_Out(Inductance_Error, Wh_P, Wh_D);
   80   2          count = 0;
   81   2        }
   82   1        count++;
   83   1        return (int)nh_Turn_Out(wh_out, Nh_P, Nh_D) * count / 3;
   84   1      }
   85          /**
   86           * @brief 角度环
   87           *
   88           * @param target 目标角度
   89           * @param actual 实际角度
   90           */
   91          int Angle_Ring(double target, double actual, float p, float i, float d)
   92          {
   93   1        float error;
   94   1        static float last_error = 0, Ki_val = 0;
   95   1        int Output;
   96   1        float error_derivative;
   97   1        // 计算位置误差
   98   1        error = target - actual;
   99   1        Ki_val += error;
  100   1        if (Ki_val > 1000)
  101   1          Ki_val = 1000;
  102   1        if (Ki_val < -1000)
  103   1          Ki_val = -1000;
  104   1        // 计算位置误差变化率
  105   1        error_derivative = error - last_error;
  106   1        // 计算PD控制器的输出
  107   1        Output = (int)error * p + error_derivative * d + Ki_val * i;
  108   1        // 更新上一时刻的位置误差
  109   1        last_error = error;
  110   1        // 对输出进行限幅
  111   1        Output = limit(Output, Angle_MAX);
  112   1        Motor_PWM(-Output, +Output);
  113   1        if (abs(error) < 5) // 如果误差小于5度代表到达目标角度
  114   1        {
  115   2          return 1;
  116   2        }
  117   1        return 0;
  118   1      }
  119          
  120          /**
  121           * @brief  方向环方案二，陀螺仪作为d项抑制
  122           *
C251 COMPILER V5.60.0,  direction                                                          06/05/24  21:14:49  PAGE 3   
=======
   51   1        int error1 = 0;
   52   1        static float last_err = 0, nh_out = 0, P_out = 0, I_out = 0;
   53   1        error1 = err - mpu6050_gyro_z / 65.6;
   54   1        P_out += dir_p * (error1-last_err);
   55   1        I_out += dir_i * error1;
   56   1        if(I_out>2700)
C251 COMPILER V5.60.0,  direction                                                          06/05/24  21:25:56  PAGE 2   

   57   1          I_out = 2700;
   58   1        if(I_out < -2700)
   59   1          I_out = -2700; 
   60   1        nh_out = P_out + I_out;
   61   1        last_err = error1;
   62   1        return (int)nh_out;
   63   1      }
   64          
   65          //--
   66          //@brief      方向环控制（内环1ms外环3ms）
   67          //@param      void
   68          //@return     方向环输出
   69          //-
   70          int DirControl(void)
   71          {
   72   1        static int count = 0;
   73   1        static int wh_out = 0;
   74   1        if (count == 3)
   75   1        {
   76   2          wh_out = wh_Turn_Out(Inductance_Error, Wh_P, Wh_D);
   77   2          count = 0;
   78   2        }
   79   1        count++;
   80   1        return (int)nh_Turn_Out(wh_out, Nh_P, Nh_D) * count / 3;
   81   1      }
   82          /**
   83           * @brief 角度环
   84           *
   85           * @param target 目标角度
   86           * @param actual 实际角度
   87           */
   88          int Angle_Ring(double target, double actual, float p, float i, float d)
   89          {
   90   1        float error;
   91   1        static float last_error = 0, Ki_val = 0;
   92   1        int Output;
   93   1        float error_derivative;
   94   1        // 计算位置误差
   95   1        error = target - actual;
   96   1        Ki_val += error;
   97   1        if (Ki_val > 1000)
   98   1          Ki_val = 1000;
   99   1        if (Ki_val < -1000)
  100   1          Ki_val = -1000;
  101   1        // 计算位置误差变化率
  102   1        error_derivative = error - last_error;
  103   1        // 计算PD控制器的输出
  104   1        Output = (int)error * p + error_derivative * d + Ki_val * i;
  105   1        // 更新上一时刻的位置误差
  106   1        last_error = error;
  107   1        // 对输出进行限幅
  108   1        Output = limit(Output, Angle_MAX);
  109   1        Motor_PWM(-Output, +Output);
  110   1        if (abs(error) < 5) // 如果误差小于5度代表到达目标角度
  111   1        {
  112   2          return 1;
  113   2        }
  114   1        return 0;
  115   1      }
  116          
  117          /**
  118           * @brief  方向环方案二，陀螺仪作为d项抑制
  119           *
  120           * @param chazhi
  121           * @param dir_p
  122           * @param dir_d
C251 COMPILER V5.60.0,  direction                                                          06/05/24  21:25:56  PAGE 3   
>>>>>>> 璋

  123           * @param dir_d2
  124           * @return int
  125           */
  126          int DirControl_2(int16 chazhi, float dir_p, float dir_d, float dir_d2)
  127          {
*** WARNING C57 IN LINE 127 OF ..\USER\Hardware\direction.c: parameter 1: different from declaration
  128   1        float error;
  129   1        static float last_error = 0;
  130   1        float Output;
  131   1        float error_derivative;
  132   1        // 计算位置误差
  133   1        error = chazhi;
  134   1        // 计算位置误差变化率
  135   1        error_derivative = error - last_error;
  136   1        // 计算PD控制器的输出
  137   1        Output = error * dir_p + error_derivative * dir_d + mpu6050_gyro_z * dir_d2;
  138   1        // 更新上一时刻的位置误差
  139   1        last_error = error;
  140   1        // 对输出进行限幅
  141   1        Output = limit(Output, out_max);
  142   1        return (int)Output;
  143   1      }


Module Information          Static   Overlayable
------------------------------------------------
<<<<<<< HEAD
  code size            =       700     ------
=======
  code size            =       777     ------
>>>>>>> 璋
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =       142     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =       108     ------
End of Module Information.


C251 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
