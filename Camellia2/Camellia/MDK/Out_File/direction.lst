C251 COMPILER V5.60.0,  direction                                                          18/07/24  16:15:50  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE direction
OBJECT MODULE PLACED IN .\Out_File\direction.obj
COMPILER INVOKED BY: F:\Keil_c251\C251\BIN\C251.EXE ..\USER\Hardware\direction.c XSMALL WARNINGLEVEL(3) OPTIMIZE(0,SPEED
                    -) BROWSE INCDIR(..\..\Libraries\libraries;..\..\Libraries\seekfree_libraries;..\..\Libraries\seekfree_peripheral;..\CODE
                    -;..\USER\inc;..\USER\src;..\USER\Hardware;..\USER\Hardware) DEBUG PRINT(.\Out_File\direction.lst) TABS(2) OBJECT(.\Out_F
                    -ile\direction.obj) 

stmt  level    source

    1          /*
    2           * @Description:
    3           * @Author: Yzhi
    4           * @Date: 2023-11-17 21:24:19
    5           * @LastEditTime: 2024-01-19 11:52:20
    6           * @LastEditors: Yzhi
    7           */
    8          #include "myconfig.h"
    9          
   10          #define out_max 5000
   11          #define Angle_MAX 3500
   12          
   13          
   14          
   15          // float Nh_P = 9000; //增量式参数
   16          // float Nh_D = 800;
   17          
   18          float Nh_P = 11.5; //位置式参数
   19          float Nh_D = 7.5;
   20          
   21          float Wh_P = 160;
   22          float Wh_D = 240;
   23          float KP1 = 0;
   24          float KP2 = 0;
   25          float gyro_z3 = 0;
   26          
   27          float KP3 = 0;
   28          float KD1 = 0;
   29          float KD2 = 0;
   30          float Feedforward_gain = 0;
   31          
   32          float Angle_Speed_P = 11.5;
   33          float Angle_Speed_D = 7;
   34          
   35          
   36          
   37          float Angle_P = 250;
   38          float Angle_D = 120;
   39          
   40          float Target_Vel_Z_pre = 0;
   41          int Speed_Ring_Flag = 0;
   42          
   43          Position_PID_InitTypedef Position;
   44          
   45          /**
   46           * @brief 外环
   47           *
   48           * @param chazhi 电感差值PD控制
   49           * @param dir_p  KP
   50           * @param dir_d  KD
   51           * @return int   外环返回值
   52           */
   53          
   54          float wh_Turn_Out(int16 chazhi, float dir_p, float dir_d)
   55          {
   56   1        float error, p;
C251 COMPILER V5.60.0,  direction                                                          18/07/24  16:15:50  PAGE 2   

   57   1        static float last_error = 0,Angle_speed=0;
   58   1        float Output, KP2_OUT;
   59   1        float error_derivative;
   60   1      
   61   1        if(chazhi<20&&chazhi>-20)
   62   1          chazhi = chazhi * 0.3;
   63   1        error = chazhi;
   64   1      
   65   1        p = dir_p + abs(error) * KP1;
   66   1        error_derivative = error - last_error;
   67   1        Output = error * p + error_derivative * dir_d;
   68   1        last_error = error;
   69   1        Output = limit(Output, out_max);
   70   1      
   71   1      
   72   1        return Output;
   73   1      }
*** WARNING C47 IN LINE 58 OF ..\USER\Hardware\direction.c: 'KP2_OUT': unreferenced local variable
   74          
   75          /**
   76           * @brief 内环角速度PI控制
   77           *
   78           * @param err   外环输入值
   79           * @param dir_p
   80           * @param dir_i
   81           * @return int
   82           */
   83          int16 nh_Turn_Out(float err, float dir_p, float dir_d)
   84          {
   85   1        double error1 = 0;
   86   1        static double last_err = 0, P_out = 0, I_out = 0, out = 0,last_GRYO_Z,D_out;
   87   1      
   88   1        last_GRYO_Z = mpu6050_gyro_z;
   89   1        mpu6050_gyro_z *= 0.8;
   90   1        mpu6050_gyro_z += last_GRYO_Z * 0.2;
   91   1      
   92   1        error1 = err - mpu6050_gyro_z;
   93   1      
   94   1        P_out = error1 * dir_p;
   95   1        D_out = (error1 - last_err) * dir_d;
   96   1      
   97   1        last_err = error1;
   98   1      
   99   1        out = P_out + D_out;
  100   1      
  101   1        if(out>10000)
  102   1          out = 10000;
  103   1        else if(out<-10000)
  104   1          out = -10000;
  105   1      
  106   1        if(Inductance_Error<50&&Inductance_Error>-50&&L2_NOR_ADC<10&&R2_NOR_ADC<10)
  107   1        {
  108   2          if (out > 3000)
  109   2            out = 3000;
  110   2          else if (out < -3000)
  111   2            out = -3000;
  112   2        }
  113   1          return (int16)out;
  114   1      }
  115          
  116          /**
  117           * @brief 方向环，串级PID给电机
  118           *
  119           * @return int
  120           */
  121          
C251 COMPILER V5.60.0,  direction                                                          18/07/24  16:15:50  PAGE 3   

  122          void Dir_PID_Init(void)
  123          {
  124   1        Position.kP1 = KP1;
  125   1        Position.kP2 = KP3;
  126   1        Position.kP3 = KP2;
  127   1        Position.kD = KD1;
  128   1        Position.kD2 = KD2;
  129   1        Position.feedforward_gain = Feedforward_gain;
  130   1      }
  131          
  132          int16 DirControl(int err)
  133          {
  134   1        static int count = 0;
  135   1        static int wh_out = 0;
  136   1        if (count == 3)
  137   1        {
  138   2          wh_out = wh_Turn_Out(err, Wh_P, Wh_D);
  139   2          count = 0;
  140   2        }
  141   1        count++;
  142   1        return (int16)nh_Turn_Out(wh_out, Nh_P, Nh_D);
  143   1      }
  144          
  145          int Turn_Angle(float Angle, float Actual)
  146          {
  147   1        static int count = 0;
  148   1        static int whout = 0;
  149   1        count++;
  150   1        if (count == 3)
  151   1        {
  152   2          whout = Angle_Ring(Angle, Actual);
  153   2          count = 0;
  154   2        }
  155   1        return (int16)Angle_Speed_Ring(whout);
  156   1      }
  157          
  158          int Angle_Ring(float Angle, float Actual)
  159          {
  160   1        float error = 0;
  161   1        float out, out1;
  162   1        static float last_error;
  163   1        static int count = 0;
  164   1        error = Angle - Actual;
  165   1      
  166   1        out1 = error * Angle_P + (error - last_error) * Angle_D;
  167   1      
  168   1        last_error = error;
  169   1      
  170   1        out = Angle_Speed_Ring(out1);
  171   1        out = limit(out, 8500);
  172   1      
  173   1        if(error<0.1&&error>-0.1)
  174   1          out = 0;
  175   1        return out;
  176   1      }
  177          
  178          int16 Angle_Speed_Ring(float err)
  179          {
  180   1        double error1 = 0;
  181   1        static double last_err = 0, P_out = 0, I_out = 0, out = 0, last_GRYO_Z, D_out;
  182   1      
  183   1        last_GRYO_Z = mpu6050_gyro_z;
  184   1        mpu6050_gyro_z *= 0.8;
  185   1        mpu6050_gyro_z += last_GRYO_Z * 0.2;
  186   1      
  187   1        error1 = err - mpu6050_gyro_z;
C251 COMPILER V5.60.0,  direction                                                          18/07/24  16:15:50  PAGE 4   

  188   1      
  189   1        P_out = error1 * Angle_Speed_P;
  190   1        D_out = (error1 - last_err) * Angle_Speed_D;
  191   1      
  192   1        last_err = error1;
  193   1      
  194   1        out = P_out + D_out;
  195   1      
  196   1        if (out > 10000)
  197   1          out = 10000;
  198   1        else if (out < -10000)
  199   1          out = -10000;
  200   1        return (int16)out;
  201   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      1139     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =       284     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =       244     ------
End of Module Information.


C251 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
