C251 COMPILER V5.60.0,  Inductance                                                         18/07/24  15:58:35  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE Inductance
OBJECT MODULE PLACED IN .\Out_File\Inductance.obj
COMPILER INVOKED BY: F:\Keil_c251\C251\BIN\C251.EXE ..\USER\Hardware\Inductance.c XSMALL WARNINGLEVEL(3) OPTIMIZE(0,SPEE
                    -D) BROWSE INCDIR(..\..\Libraries\libraries;..\..\Libraries\seekfree_libraries;..\..\Libraries\seekfree_peripheral;..\COD
                    -E;..\USER\inc;..\USER\src;..\USER\Hardware;..\USER\Hardware) DEBUG PRINT(.\Out_File\Inductance.lst) TABS(2) OBJECT(.\Out
                    -_File\Inductance.obj) 

stmt  level    source

    1          /*
    2           * @Description:
    3           * @Author: Yzhi
    4           * @Date: 2023-11-17 20:11:13
    5           * @LastEditTime: 2023-11-28 17:34:59
    6           * @LastEditors: Yzhi
    7           */
    8          #include "myconfig.h"
    9          
   10          #define filter_n 9 // æ•°ç»„é•¿åº¦
   11          
   12          uint16 Left_Val = 0, Right_Val = 0;
   13          int16 ad_sum = 0;
   14          int16 ad_diff = 0;
   15          uint16 ad_value[7][10] = {0};    // åŸå§‹æ•°æ®
   16          uint16 R1, R2, R3, L1, L2, L3, M1; // æ»¤æ³¢ä¹‹åçš„ç”µæ„Ÿå€¼
   17          uint16 L1_NOR_ADC = 0, R1_NOR_ADC = 0, L2_NOR_ADC = 0, R2_NOR_ADC = 0, L3_NOR_ADC = 0, R3_NOR_ADC = 0, M1
             -_NOR_ADC = 0;
   18          float NOR_VAL[7] = {0};
   19          float AD_NOR_VAL[7] = {0};  // å½’ä¸€åŒ–å€¼
   20          int16 Inductance_Error = 0; // ç”µæ„Ÿè¯¯å·®
   21          uint16 ADC_MIN[7] = {400,400,400,400,400,400,400};
   22          uint16 ADC_MAX[7] = {3200,3200,3200,4200,3200,3200,3200}; // æµ‹å‡ºçš„ç”µæ„Ÿæœ€å¤§ï¼Œä¸æœ€å°å€¼ä»å·¦åˆ
             -°å³
   23          
   24          int bug = 0;
   25          
   26          float I1 = 2.7;
   27          float I2 = 2.7;  //ç”µæ„Ÿæƒå€¼
   28          /**
   29           *  @brief      ADCé‡‡é›†åˆå§‹åŒ–
   30           *  @param      void
   31           *  @return     void
   32           **/
   33          
   34          void Inductance_Init(void)
   35          {
   36   1        adc_init(ADC_P10, ADC_SYSclk_DIV_2);
   37   1        adc_init(ADC_P05, ADC_SYSclk_DIV_2);
   38   1        adc_init(ADC_P06, ADC_SYSclk_DIV_2);
   39   1        adc_init(ADC_P00, ADC_SYSclk_DIV_2);
   40   1        adc_init(ADC_P01, ADC_SYSclk_DIV_2);
   41   1        adc_init(ADC_P02, ADC_SYSclk_DIV_2);
   42   1        adc_init(ADC_P03, ADC_SYSclk_DIV_2);
   43   1        adc_init(ADC_P04, ADC_SYSclk_DIV_2);
   44   1      }
   45          /**
   46           * @brief å¿«é€Ÿå¼€æ–¹
   47           *
   48           * @param f è¢«å¼€æ–¹æ•°
   49           * @return float
   50           */
   51          float sq(float number)
   52          {
   53   1        long i;
   54   1        float x, y;
C251 COMPILER V5.60.0,  Inductance                                                         18/07/24  15:58:35  PAGE 2   

   55   1        const float f = 1.5F;
   56   1      
   57   1        x = number * 0.5F;
   58   1        y = number;
   59   1        i = *(long *)&y;
   60   1        i = 0x5f3759df - (i >> 1);
   61   1        y = *(float *)&i;
   62   1        y = y * (f - (x * y * y));
   63   1        y = y * (f - (x * y * y));
   64   1        return number * y;
   65   1      }
   66          
   67          
   68          //5ç”µæ„Ÿå¾ªè¿¹
   69          /**
   70           *  @brief      å½’ä¸€åŒ–å¤„ç†ç”µæ„Ÿå€¼å¹¶å¾ªè¿¹æ§åˆ¶
   71           *  @param      I1,I2,åŠ æƒç³»æ•°,
   72           *  @return     void
   73           **/
   74          int16 NORMALIZATION_TRACKING_ADC(void)
   75          {
   76   1        int i = 0, j = 0, k = 0, temp = 0,err=0;
   77   1        float weight = 0;
   78   1        int ad_sum1[7] = {0};
   79   1        uint16 ad_valu1[7] = {0};
   80   1        // 1 3 4  2 7 8 6
   81   1        for (i = 0; i < 10; i++) // è¯»å–åæ¬¡ç”µæ„Ÿ
   82   1        {
   83   2          ad_value[0][i] = adc_once(ADC_P00, ADC_12BIT);  
   84   2          ad_value[1][i] = adc_once(ADC_P02, ADC_12BIT);  
   85   2          ad_value[2][i] = adc_once(ADC_P03, ADC_12BIT);  
   86   2          ad_value[3][i] = adc_once(ADC_P04, ADC_12BIT); 
   87   2          ad_value[4][i] = adc_once(ADC_P10, ADC_12BIT);
   88   2          ad_value[5][i] = adc_once(ADC_P06, ADC_12BIT);
   89   2          ad_value[6][i] = adc_once(ADC_P01, ADC_12BIT);
   90   2          bug = adc_once(ADC_P05, ADC_12BIT);
   91   2        }
   92   1      
   93   1        /*=========================å†’æ³¡æ’åºå‡åº==========================*/
   94   1        for (i = 0; i < 7; i++)
   95   1        {
   96   2          for (j = 0; j < 10 - 1; j++)
   97   2          {
   98   3            for (k = 0; k < 10 - 1 - j; k++)
   99   3            {
  100   4              if (ad_value[i][k] > ad_value[i][k + 1]) // å‰é¢çš„æ¯”åé¢çš„å¤§ï¼Œåˆ™è¿›è¡Œäº¤æ¢
  101   4              {
  102   5                temp = ad_value[i][k + 1];
  103   5                ad_value[i][k + 1] = ad_value[i][k];
  104   5                ad_value[i][k] = temp;
  105   5              }
  106   4            }
  107   3          }
  108   2        }
  109   1      
  110   1        /*===========================ä¸­å€¼æ»¤æ³¢=================================*/
  111   1        for (i = 0; i < 7; i++) // æ±‚ä¸­é—´å…«é¡¹çš„å’Œ
  112   1        {
  113   2          for (k = 0; k < 9; k++) // èˆå¼ƒæœ€å¤§å€¼å’Œæœ€å°å€¼ï¼Œåªå–ä¸­é—´8é¡¹
  114   2          {
  115   3            ad_sum1[i] += ad_value[i][k];
  116   3          } 
  117   2          ad_valu1[i] = ad_sum1[i] / 8;
  118   2        }
  119   1      
  120   1        /*=========================èµ‹å€¼å„ä¸ªç”µæ„Ÿ==============================*/
C251 COMPILER V5.60.0,  Inductance                                                         18/07/24  15:58:35  PAGE 3   

  121   1        L1 = ad_valu1[0];
  122   1        L2 = ad_valu1[1];
  123   1        L3 = ad_valu1[2];
  124   1        M1 = ad_valu1[3];
  125   1        R3 = ad_valu1[4];
  126   1        R2 = ad_valu1[5];
  127   1        R1 = ad_valu1[6];
  128   1      
  129   1        NOR_VAL[0] = (float)(L1 - ADC_MIN[0]) / (float)(ADC_MAX[0] - ADC_MIN[0]);
  130   1        NOR_VAL[1] = (float)(L2 - ADC_MIN[1]) / (float)(ADC_MAX[1] - ADC_MIN[1]);
  131   1        NOR_VAL[2] = (float)(L3 - ADC_MIN[2]) / (float)(ADC_MAX[2] - ADC_MIN[2]);
  132   1        NOR_VAL[3] = (float)(M1 - ADC_MIN[3]) / (float)(ADC_MAX[3] - ADC_MIN[3]);
  133   1        NOR_VAL[4] = (float)(R3 - ADC_MIN[4]) / (float)(ADC_MAX[4] - ADC_MIN[4]);
  134   1        NOR_VAL[5] = (float)(R2 - ADC_MIN[5]) / (float)(ADC_MAX[5] - ADC_MIN[5]);
  135   1        NOR_VAL[6] = (float)(R1 - ADC_MIN[6]) / (float)(ADC_MAX[6] - ADC_MIN[6]);
  136   1      
  137   1        for (i = 0; i < 7; i++)
  138   1        {
  139   2          if (NOR_VAL[i] <= 0.0)
  140   2          {
  141   3            NOR_VAL[i] = 0.001;
  142   3          }
  143   2          if (NOR_VAL[i] > 1.0)
  144   2          {
  145   3            NOR_VAL[i] = 1.0;
  146   3          }
  147   2          AD_NOR_VAL[i] = NOR_VAL[i] * 100;
  148   2        }
  149   1      
  150   1        L1_NOR_ADC = AD_NOR_VAL[0];
  151   1        L2_NOR_ADC = AD_NOR_VAL[1];
  152   1        L3_NOR_ADC = AD_NOR_VAL[2];
  153   1        M1_NOR_ADC = AD_NOR_VAL[3];
  154   1        R3_NOR_ADC = AD_NOR_VAL[4];
  155   1        R2_NOR_ADC = AD_NOR_VAL[5];
  156   1        R1_NOR_ADC = AD_NOR_VAL[6];
  157   1      
  158   1        L1_NOR_ADC = L1_NOR_ADC;
*** WARNING C138 IN LINE 158 OF ..\USER\Hardware\Inductance.c: expression with possibly no effect
  159   1        L2_NOR_ADC = L2_NOR_ADC * I1;
  160   1        R1_NOR_ADC = R1_NOR_ADC;
*** WARNING C138 IN LINE 160 OF ..\USER\Hardware\Inductance.c: expression with possibly no effect
  161   1        R2_NOR_ADC = R2_NOR_ADC*I2;
  162   1      
  163   1        //åŠ¨æ€æƒé‡
  164   1        Left_Val = sq(L1_NOR_ADC * L1_NOR_ADC + L2_NOR_ADC * L2_NOR_ADC);
  165   1        Right_Val = sq(R1_NOR_ADC * R1_NOR_ADC + R2_NOR_ADC * R2_NOR_ADC);
  166   1        ad_sum = Left_Val + Right_Val+ M1_NOR_ADC;
  167   1        ad_diff = Left_Val - Right_Val;
  168   1        if(L2_NOR_ADC>20&&R2_NOR_ADC<10)
  169   1          err = 20;
  170   1        if (R2_NOR_ADC>50 && L2_NOR_ADC < 10)
  171   1          err = -20;
  172   1        if (L2_NOR_ADC > 10 && R2_NOR_ADC < 5)
  173   1          err = 30;
  174   1        if (R2_NOR_ADC > 10 && L2_NOR_ADC < 5)
  175   1          err = -30;
  176   1        if (ad_sum > 35)
  177   1        {
  178   2          Inductance_Error = ((ad_diff << 7) / ((ad_sum + 1)))+err;
  179   2        }
  180   1        return Inductance_Error; // æ”¾å¤§128å€
  181   1      }
  182          
  183          /**
  184           *  @brief      æ˜¾ç¤ºæµ‹é‡å€¼
C251 COMPILER V5.60.0,  Inductance                                                         18/07/24  15:58:35  PAGE 4   

  185           *  @param      void
  186           *  @return     void
  187           **/
  188          
  189          void show_val(void)
  190          {
  191   1        //-----------------oledæ˜¾ç¤ºç”µæ„Ÿå€¼----------------------//
  192   1        oled_p6x8str(0, 0, "L1:");
  193   1        oled_uint16(15, 0, L1_NOR_ADC);
  194   1      
  195   1        oled_p6x8str(70, 0, "R1:");
  196   1        oled_uint16(85, 0, R1_NOR_ADC);
  197   1      
  198   1        oled_p6x8str(0, 1, "L2:");
  199   1        oled_uint16(15, 1, L2_NOR_ADC);
  200   1      
  201   1        oled_p6x8str(70, 1, "R2:");
  202   1        oled_uint16(85, 1, R2_NOR_ADC);
  203   1      
  204   1        oled_p6x8str(0, 2, "L3:");
  205   1        oled_uint16(15, 2, L3_NOR_ADC);
  206   1      
  207   1        oled_p6x8str(70,2, "R3:");
  208   1        oled_uint16(85, 2, R3_NOR_ADC);
  209   1      
  210   1        oled_p6x8str(0, 3, "M1:");
  211   1        oled_uint16(15, 3, M1_NOR_ADC);
  212   1      
  213   1        oled_p6x8str(55, 3, "Err:");
  214   1        oled_int16(80, 3,Inductance_Error);
  215   1      
  216   1        ////-----------------é™€èºä»ªè§’é€Ÿåº¦------------------------//
  217   1        oled_int16(0, 4, L_Pulse);
  218   1        oled_int16(60, 4, R_Pulse);
  219   1        oled_p6x8str(0, 5, "LPWM:");
  220   1        oled_int16(25, 5, LMotor_PWM);
  221   1        oled_p6x8str(0,6, "RPWM:");
  222   1        oled_int16(25, 6, RMotor_PWM);
  223   1        oled_p6x8str(65, 6, "Dis");
  224   1        oled_int16(80, 6, dl1a_distance_mm);
  225   1        oled_p6x8str(0, 7, "G_z");
  226   1        oled_int16(20, 7, mpu6050_gyro_z);
  227   1        //oled_int16(20, 7, Sum_Pulse);
  228   1        //-----------------TOFè·ç¦»------------------------//
  229   1        //  if(dl1a_finsh_flag)
  230   1        //  {
  231   1        //    dl1a_finsh_flag = 0;
  232   1        //    oled_int16(60,6,dl1a_distance_mm);
  233   1        //  }
  234   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      2302     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =       334     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
C251 COMPILER V5.60.0,  Inductance                                                         18/07/24  15:58:35  PAGE 5   

  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =       419     ------
End of Module Information.


C251 COMPILATION COMPLETE.  2 WARNING(S),  0 ERROR(S)
