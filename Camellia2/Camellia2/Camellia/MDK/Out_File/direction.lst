C251 COMPILER V5.60.0,  direction                                                          10/04/24  21:46:07  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE direction
OBJECT MODULE PLACED IN .\Out_File\direction.obj
COMPILER INVOKED BY: F:\Keil_c251\C251\BIN\C251.EXE ..\USER\Hardware\direction.c XSMALL WARNINGLEVEL(3) OPTIMIZE(0,SPEED
                    -) BROWSE INCDIR(..\..\Libraries\libraries;..\..\Libraries\seekfree_libraries;..\..\Libraries\seekfree_peripheral;..\CODE
                    -;..\USER\inc;..\USER\src;..\USER\Hardware;..\USER\Hardware) DEBUG PRINT(.\Out_File\direction.lst) TABS(2) OBJECT(.\Out_F
                    -ile\direction.obj) 

stmt  level    source

    1          /*
    2           * @Description:
    3           * @Author: Yzhi
    4           * @Date: 2023-11-17 21:24:19
    5           * @LastEditTime: 2024-01-19 11:52:20
    6           * @LastEditors: Yzhi
    7           */
    8          #include "myconfig.h"
    9          
   10          #define out_max 20000
   11          #define Angle_MAX 3500
   12          
   13          float Nh_P = 0.7;
   14          float Nh_D = 0.8;
   15          float Wh_P = 100;
   16          float Wh_D = 185;
   17          
   18          //--
   19          //@brief      方向环(外环) 位置式
   20          //@param      c hazhi : 电感差值 KP 比例 KI 积分 KD 微分
   21          //@return     void
   22          //--
   23          
   24          int wh_Turn_Out(int16 chazhi, float dir_p, float dir_d)
   25          {
   26   1        float error;
   27   1        static float last_error = 0;
   28   1        float Output;
   29   1        float error_derivative;
   30   1        // 计算位置误差
   31   1        error = chazhi;
   32   1        // 计算位置误差变化率
   33   1        error_derivative = error - last_error;
   34   1        // 计算PD控制器的输出
   35   1        Output = error * dir_p + error_derivative * dir_d;
   36   1        // 更新上一时刻的位置误差
   37   1        last_error = error;
   38   1        // 对输出进行限幅
   39   1        Output = limit(Output, out_max);
   40   1        return (int)Output;
   41   1      }
   42          
   43          //--
   44          //@brief      方向环(内环) 位置式
   45          //@param      chazhi : 电感差值 KP 比例 KI 积分 KD 微分
   46          //@return     void
   47          //--
   48          
   49          int nh_Turn_Out(int err, float dir_p, float dir_d)
   50          {
   51   1        float error;
   52   1        static float last_error = 0;
   53   1        float Output;
   54   1        float error_derivative;
   55   1        // 计算位置误差
   56   1        error = err - Get_Angle() * 0.0075;
C251 COMPILER V5.60.0,  direction                                                          10/04/24  21:46:07  PAGE 2   

   57   1        // 计算位置误差变化率
   58   1        error_derivative = error - last_error;
   59   1        // 计算PD控制器的输出
   60   1        Output = (int)(error * dir_p + error_derivative * dir_d);
   61   1        // 更新上一时刻的位置误差
   62   1        last_error = error;
   63   1        // 对输出进行限幅
   64   1        Output = limit(Output, out_max);
   65   1        return (int)Output;
   66   1      }
   67          
   68          //--
   69          //@brief      方向环控制（内环1ms外环3ms）
   70          //@param      void
   71          //@return     方向环输出
   72          //-
   73          int DirControl(void)
   74          {
   75   1        static int count = 0;
   76   1        static int wh_out = 0;
   77   1        if (count == 3)
   78   1        {
   79   2          wh_out = wh_Turn_Out(Inductance_Error, Wh_P, Wh_D);
   80   2          count = 0;
   81   2        }
   82   1        count++;
   83   1        return (int)nh_Turn_Out(wh_out, Nh_P, Nh_D) * count / 3;
   84   1      }
   85          /**
   86           * @brief 角度环
   87           *
   88           * @param target 目标角度
   89           * @param actual 实际角度
   90           */
   91          int Angle_Ring(double target, double actual, float p, float i, float d)
   92          {
   93   1        float error;
   94   1        static float last_error = 0, Ki_val = 0;
   95   1        int Output;
   96   1        float error_derivative;
   97   1        // 计算位置误差
   98   1        error = target - actual;
   99   1        Ki_val += error;
  100   1        if (Ki_val > 1000)
  101   1          Ki_val = 1000;
  102   1        if (Ki_val < -1000)
  103   1          Ki_val = -1000;
  104   1        // 计算位置误差变化率
  105   1        error_derivative = error - last_error;
  106   1        // 计算PD控制器的输出
  107   1        Output = (int)error * p + error_derivative * d + Ki_val * i;
  108   1        // 更新上一时刻的位置误差
  109   1        last_error = error;
  110   1        // 对输出进行限幅
  111   1        Output = limit(Output, Angle_MAX);
  112   1        Motor_PWM(-Output, +Output);
  113   1        if (abs(error) < 5) // 如果误差小于5度代表到达目标角度
  114   1        {
  115   2          return 1;
  116   2        }
  117   1        return 0;
  118   1      }
  119          
  120          /**
  121           * @brief  方向环方案二，陀螺仪作为d项抑制
  122           *
C251 COMPILER V5.60.0,  direction                                                          10/04/24  21:46:07  PAGE 3   

  123           * @param chazhi
  124           * @param dir_p
  125           * @param dir_d
  126           * @param dir_d2
  127           * @return int
  128           */
  129          int DirControl_2(int16 chazhi, float dir_p, float dir_d, float dir_d2)
  130          {
*** WARNING C57 IN LINE 130 OF ..\USER\Hardware\direction.c: parameter 1: different from declaration
  131   1        float error;
  132   1        static float last_error = 0;
  133   1        float Output;
  134   1        float error_derivative;
  135   1        // 计算位置误差
  136   1        error = chazhi;
  137   1        // 计算位置误差变化率
  138   1        error_derivative = error - last_error;
  139   1        // 计算PD控制器的输出
  140   1        Output = error * dir_p + error_derivative * dir_d + mpu6050_gyro_z * dir_d2;
  141   1        // 更新上一时刻的位置误差
  142   1        last_error = error;
  143   1        // 对输出进行限幅
  144   1        Output = limit(Output, out_max);
  145   1        return (int)Output;
  146   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       694     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =       140     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        84     ------
End of Module Information.


C251 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
